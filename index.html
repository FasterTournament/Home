<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Live - Voice & Stream</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: #0d141f; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            color: white; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        .header {
            background: linear-gradient(135deg, #1a2536 0%, #0d141f 100%);
            padding: 12px 20px;
            border-bottom: 1px solid #1c2a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .user-info {
            font-size: 13px;
            background: rgba(59, 130, 246, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .banner { 
            width: 100%; 
            height: 230px; 
            background: #000; 
            border-bottom: 1px solid #1c2a3a; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stream-info {
            text-align: center;
            padding: 20px;
        }
        
        .stream-title {
            color: #3b82f6;
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .stream-status {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .stream-status.connected {
            color: #10b981;
            font-weight: bold;
        }
        
        .content { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 16px;
            color: #3b82f6;
        }
        
        .online-count {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .user-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 12px; 
        }
        
        .user-card { 
            background-color: #162130; 
            border-radius: 12px; 
            padding: 12px; 
            display: flex; 
            align-items: center; 
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        
        .user-card.me {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .avatar { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            margin-right: 12px; 
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 2px solid transparent; 
            font-size: 18px;
        }
        
        .avatar.speaking {
            border-color: #3b82f6 !important; 
            animation: pulse 1.2s infinite alternate; 
        }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6); } 
            100% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); } 
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .user-status {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .status-online {
            background: #10b981;
        }
        
        .status-speaking {
            background: #3b82f6;
            animation: pulse 1s infinite;
        }
        
        .status-muted {
            background: #6b7280;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        .controls { 
            display: flex; 
            justify-content: space-around; 
            padding: 20px 10px; 
            background-color: #0d141f; 
            border-top: 1px solid #1c2a3a; 
        }
        
        .control-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer; 
            background: none; 
            border: none; 
            color: #94a3b8; 
            outline: none; 
            transition: all 0.3s ease;
            min-width: 70px;
        }
        
        .control-btn:hover {
            color: white;
            transform: translateY(-2px);
        }
        
        .icon-circle { 
            width: 52px; 
            height: 52px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #2d3748, #1a2536);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            color: white; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .control-btn.active .icon-circle { 
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-red .icon-circle { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .btn-red:hover .icon-circle {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #94a3b8;
            font-size: 14px;
        }
        
        .loading i {
            font-size: 20px;
            margin-bottom: 10px;
            display: block;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0d141f;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }
        
        /* Connection status animation */
        .connection-pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-right: 6px;
            animation: connectionPulse 2s infinite;
        }
        
        @keyframes connectionPulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">Guild Live</div>
        <div class="user-info" id="myIdDisplay">Loading...</div>
    </div>

    <div class="banner" id="videoContainer">
        <div class="stream-info">
            <div class="stream-title">Voice Chat Room</div>
            <div class="stream-status" id="connectionStatus">
                <span class="connection-pulse"></span>
                Connecting to server...
            </div>
        </div>
    </div>

    <div class="content">
        <div class="section-header">
            <div class="section-title">Voice Participants</div>
            <div class="online-count" id="userCount">0 Online</div>
        </div>
        <div class="user-list" id="userList">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                Loading active users...
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn active" id="speakerBtn">
            <div class="icon-circle"><i class="fas fa-volume-up"></i></div>
            <span>Speaker</span>
        </button>
        <button class="control-btn" id="micBtn">
            <div class="icon-circle"><i class="fas fa-microphone-slash" id="micIcon"></i></div>
            <span id="micText">Unmute</span>
        </button>
        <button class="control-btn btn-red" id="leaveBtn">
            <div class="icon-circle"><i class="fas fa-phone-slash"></i></div>
            <span>Leave</span>
        </button>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCSoTqqSC_NqigWrHwE4Q8IUvWRP9TrxG8",
            authDomain: "top-up-4db01.firebaseapp.com",
            databaseURL: "https://top-up-4db01-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "top-up-4db01",
            storageBucket: "top-up-4db01.appspot.com",
            messagingSenderId: "264548197473",
            appId: "1:264548197473:android:4c986618c48182125d7620"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // User Information
        const myId = "User_" + Math.floor(Math.random() * 9000 + 1000);
        let localStream = null;
        let isMuted = true;
        const activePeers = {};
        const audioElements = {};
        
        // Clean old data from Firebase (older than 30 seconds)
        function cleanupOldUsers() {
            const now = Date.now();
            database.ref('active_users').once('value').then(snapshot => {
                const updates = {};
                snapshot.forEach(child => {
                    const userData = child.val();
                    if (now - userData.lastSeen > 30000) { // 30 seconds
                        updates[child.key] = null;
                    }
                });
                if (Object.keys(updates).length > 0) {
                    database.ref('active_users').update(updates);
                }
            });
        }
        
        // Initialize Application
        async function initApp() {
            console.log("üöÄ Initializing Guild Live Voice Chat...");
            console.log("Your ID:", myId);
            
            // Update UI with my ID
            document.getElementById('myIdDisplay').textContent = `You: ${myId}`;
            document.getElementById('connectionStatus').innerHTML = `
                <span class="connection-pulse"></span>
                Connected as <strong>${myId}</strong>
            `;
            
            try {
                // Get microphone access
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                // Start with muted microphone
                localStream.getAudioTracks()[0].enabled = false;
                isMuted = true;
                
                console.log("‚úÖ Microphone access granted");
                
                // Setup controls
                setupControls();
                
                // Connect to Firebase
                setupFirebaseConnection();
                
                // Cleanup old data periodically
                setInterval(cleanupOldUsers, 10000);
                
            } catch (error) {
                console.error("‚ùå Microphone error:", error);
                document.getElementById('connectionStatus').innerHTML = `
                    <span style="color: #ef4444;">
                        <i class="fas fa-exclamation-circle"></i> 
                        Microphone access required
                    </span>
                `;
            }
        }
        
        // Setup Firebase realtime connection
        function setupFirebaseConnection() {
            // Set my presence in Firebase
            const userRef = database.ref('active_users/' + myId);
            
            // Set initial data
            userRef.set({
                id: myId,
                isMuted: isMuted,
                lastSeen: Date.now(),
                connected: true
            });
            
            // Update lastSeen every 5 seconds
            setInterval(() => {
                userRef.update({
                    lastSeen: Date.now(),
                    isMuted: isMuted
                });
            }, 5000);
            
            // Remove on disconnect
            userRef.onDisconnect().remove();
            
            // Listen for other users
            database.ref('active_users').on('value', handleUsersUpdate);
        }
        
        // Handle users update from Firebase
        function handleUsersUpdate(snapshot) {
            const users = snapshot.val();
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            if (!users || Object.keys(users).length === 0) {
                // Only me online
                userList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #94a3b8; width: 100%;">
                        <i class="fas fa-users" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>You're the only one here</p>
                        <p style="font-size: 12px; margin-top: 10px;">
                            Share your ID: <strong>${myId}</strong> with others to invite them
                        </p>
                    </div>
                `;
                userCount.textContent = "1 Online";
                return;
            }
            
            // Filter out old users (last seen > 10 seconds)
            const now = Date.now();
            const activeUsers = [];
            
            for (const userId in users) {
                const user = users[userId];
                if (now - user.lastSeen < 15000) { // 15 seconds threshold
                    activeUsers.push(user);
                }
            }
            
            // Sort: me first, then others
            activeUsers.sort((a, b) => {
                if (a.id === myId) return -1;
                if (b.id === myId) return 1;
                return b.lastSeen - a.lastSeen;
            });
            
            // Update count (REAL count)
            const realCount = activeUsers.length;
            userCount.textContent = `${realCount} Online`;
            
            // Generate user list HTML
            let html = '';
            activeUsers.forEach(user => {
                const isMe = user.id === myId;
                const isSpeaking = !user.isMuted;
                
                html += `
                    <div class="user-card ${isMe ? 'me' : ''}">
                        <div class="avatar ${isSpeaking ? 'speaking' : ''}">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name">
                                ${isMe ? 'You (Me)' : user.id}
                            </div>
                            <div class="user-status">
                                ${isMe ? 
                                    (isMuted ? 'üîá Muted' : 'üé§ Speaking') : 
                                    (isSpeaking ? 'üé§ Speaking' : 'üîá Muted')
                                }
                            </div>
                        </div>
                        <div class="status-dot ${isSpeaking ? 'status-speaking' : 'status-muted'}"></div>
                    </div>
                `;
            });
            
            userList.innerHTML = html;
            
            // Update page title with real count
            document.title = `Guild Live (${realCount} Online)`;
            
            // Establish WebRTC connections with other users
            activeUsers.forEach(user => {
                if (user.id !== myId && !activePeers[user.id]) {
                    setupPeerConnection(user.id);
                }
            });
            
            // Cleanup disconnected peers
            Object.keys(activePeers).forEach(peerId => {
                if (!activeUsers.find(u => u.id === peerId)) {
                    cleanupPeer(peerId);
                }
            });
        }
        
        // Setup WebRTC peer connection
        function setupPeerConnection(targetId) {
            if (activePeers[targetId] || !localStream) return;
            
            console.log(`üîó Setting up peer connection with ${targetId}`);
            
            const peer = new SimplePeer({
                initiator: true,
                trickle: true,
                stream: localStream,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('signal', data => {
                // Send signal through Firebase
                database.ref('signals/' + targetId).push({
                    from: myId,
                    signal: data,
                    timestamp: Date.now()
                });
            });
            
            peer.on('stream', stream => {
                console.log(`üéµ Received stream from ${targetId}`);
                playRemoteStream(targetId, stream);
            });
            
            peer.on('error', err => {
                console.error(`Peer error with ${targetId}:`, err);
                cleanupPeer(targetId);
            });
            
            activePeers[targetId] = peer;
            
            // Listen for signals from this peer
            database.ref('signals/' + myId).on('child_added', snapshot => {
                const signalData = snapshot.val();
                if (signalData.from === targetId && peer) {
                    try {
                        peer.signal(signalData.signal);
                        // Remove signal after processing
                        snapshot.ref.remove();
                    } catch (err) {
                        console.error('Signal error:', err);
                    }
                }
            });
        }
        
        // Play remote audio stream
        function playRemoteStream(userId, stream) {
            let audio = audioElements[userId];
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = 'audio-' + userId;
                audio.autoplay = true;
                audio.volume = 1.0;
                audio.setAttribute('data-user', userId);
                document.body.appendChild(audio);
                audioElements[userId] = audio;
            }
            audio.srcObject = stream;
        }
        
        // Cleanup peer connection
        function cleanupPeer(userId) {
            if (activePeers[userId]) {
                try {
                    activePeers[userId].destroy();
                } catch (e) {}
                delete activePeers[userId];
            }
            
            if (audioElements[userId]) {
                try {
                    audioElements[userId].pause();
                    audioElements[userId].srcObject = null;
                    audioElements[userId].remove();
                } catch (e) {}
                delete audioElements[userId];
            }
        }
        
        // Setup control buttons
        function setupControls() {
            // Microphone Button
            document.getElementById('micBtn').onclick = () => {
                if (!localStream) {
                    alert("Microphone not available. Please refresh.");
                    return;
                }
                
                const audioTrack = localStream.getAudioTracks()[0];
                isMuted = !audioTrack.enabled;
                audioTrack.enabled = !isMuted;
                
                // Update UI
                const micBtn = document.getElementById('micBtn');
                const micIcon = document.getElementById('micIcon');
                const micText = document.getElementById('micText');
                
                if (audioTrack.enabled) {
                    micBtn.classList.add('active');
                    micIcon.className = 'fas fa-microphone';
                    micText.textContent = 'Mute';
                    console.log('üé§ Microphone ON');
                } else {
                    micBtn.classList.remove('active');
                    micIcon.className = 'fas fa-microphone-slash';
                    micText.textContent = 'Unmute';
                    console.log('üîá Microphone OFF');
                }
                
                // Update Firebase
                database.ref('active_users/' + myId).update({
                    isMuted: isMuted,
                    lastSeen: Date.now()
                });
            };
            
            // Speaker Button
            document.getElementById('speakerBtn').onclick = () => {
                const btn = document.getElementById('speakerBtn');
                const isActive = btn.classList.contains('active');
                
                if (isActive) {
                    btn.classList.remove('active');
                    document.querySelector('#speakerBtn .icon-circle i').className = 'fas fa-volume-mute';
                    
                    // Mute all remote audio
                    Object.values(audioElements).forEach(audio => {
                        audio.volume = 0;
                    });
                    
                    console.log('üîá All speakers muted');
                } else {
                    btn.classList.add('active');
                    document.querySelector('#speakerBtn .icon-circle i').className = 'fas fa-volume-up';
                    
                    // Unmute all remote audio
                    Object.values(audioElements).forEach(audio => {
                        audio.volume = 1.0;
                    });
                    
                    console.log('üîä All speakers unmuted');
                }
            };
            
            // Leave Button
            document.getElementById('leaveBtn').onclick = () => {
                if (confirm("Are you sure you want to leave the voice chat?")) {
                    // Cleanup all connections
                    Object.keys(activePeers).forEach(userId => {
                        cleanupPeer(userId);
                    });
                    
                    // Remove from Firebase
                    database.ref('active_users/' + myId).remove();
                    database.ref('signals/' + myId).remove();
                    
                    // Stop local stream
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Redirect
                    setTimeout(() => location.reload(), 500);
                }
            };
        }
        
        // Initialize on page load
        window.addEventListener('load', initApp);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            database.ref('active_users/' + myId).remove();
            database.ref('signals/' + myId).remove();
        });
    </script>
</body>
</html>
