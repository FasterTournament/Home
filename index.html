<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Live - Voice & Stream</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0d141f; font-family: sans-serif; color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .banner { width: 100%; height: 230px; background: #000; border-bottom: 1px solid #1c2a3a; }
        #ytPlayer { width: 100%; height: 100%; border: none; }
        .content { flex: 1; padding: 15px; overflow-y: auto; }
        .user-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .user-card { background-color: #162130; border-radius: 12px; padding: 10px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background: #2d3748; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; }
        .voice-active { border-color: #3b82f6 !important; animation: pulse 0.6s infinite alternate; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6); } 100% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } }
        .controls { display: flex; justify-content: space-around; padding: 20px 10px; background-color: #0d141f; border-top: 1px solid #1c2a3a; }
        .control-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; background: none; border: none; color: #94a3b8; outline: none; }
        .icon-circle { width: 52px; height: 52px; border-radius: 50%; background-color: #2d3748; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .active .icon-circle { background-color: #3b82f6; }
        .btn-red .icon-circle { background-color: #ef4444; }
    </style>
</head>
<body>

    <div class="banner" id="videoContainer"></div>

    <div class="content">
        <div class="user-list" id="userList"></div>
    </div>

    <div class="controls">
        <button class="control-btn active" id="speakerBtn"><div class="icon-circle"><i class="fas fa-volume-up"></i></div><span>Speaker</span></button>
        <button class="control-btn" id="micBtn"><div class="icon-circle"><i class="fas fa-microphone-slash" id="micIcon"></i></div><span id="micText">Unmute</span></button>
        <button class="control-btn btn-red" id="leaveBtn"><div class="icon-circle"><i class="fas fa-phone-slash"></i></div><span>Leave</span></button>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyCSoTqqSC_NqigWrHwE4Q8IUvWRP9TrxG8",
            databaseURL: "https://top-up-4db01-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "top-up-4db01",
            appId: "1:264548197473:android:4c986618c48182125d7620"
        };
        firebase.initializeApp(config);
        const db = firebase.database();
        const myId = "User_" + Math.floor(Math.random() * 9000 + 1000);
        let localStream;
        const peers = {};

        // ১. ইউটিউব লাইভ
        db.ref('live_stream/video_id').on('value', snap => {
            if(snap.val()) document.getElementById('videoContainer').innerHTML = `<iframe id="ytPlayer" src="https://www.youtube.com/embed/${snap.val()}?autoplay=1&mute=0"></iframe>`;
        });

        // ২. অডিও এবং সিগন্যালিং শুরু
        async function startApp() {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getAudioTracks()[0].enabled = false; // শুরুতে মিউট

            db.ref('users/' + myId).set({ id: myId, isMuted: true });
            db.ref('users/' + myId).onDisconnect().remove();

            // নতুন কেউ আসলে তাকে কল করা
            db.ref('users').on('child_added', snapshot => {
                const user = snapshot.val();
                if (user.id !== myId) {
                    initiateCall(user.id);
                }
            });

            // কল রিসিভ করার লজিক
            db.ref('signals/' + myId).on('child_added', snapshot => {
                const signal = snapshot.val();
                handleSignal(signal, snapshot.key);
            });
        }

        function initiateCall(targetId) {
            const peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream });
            peer.on('signal', data => {
                db.ref('signals/' + targetId).push({ from: myId, signal: data });
            });
            peer.on('stream', stream => playRemoteStream(stream, targetId));
            peers[targetId] = peer;
        }

        function handleSignal(data, key) {
            let peer = peers[data.from];
            if (!peer) {
                peer = new SimplePeer({ initiator: false, trickle: false, stream: localStream });
                peer.on('signal', signalData => {
                    db.ref('signals/' + data.from).push({ from: myId, signal: signalData });
                });
                peer.on('stream', stream => playRemoteStream(stream, data.from));
                peers[data.from] = peer;
            }
            peer.signal(data.signal);
            db.ref('signals/' + myId).child(key).remove();
        }

        function playRemoteStream(stream, id) {
            let audio = document.getElementById('audio-' + id);
            if(!audio) {
                audio = document.createElement('audio');
                audio.id = 'audio-' + id;
                document.body.appendChild(audio);
            }
            audio.srcObject = stream;
            audio.play();
        }

        // ৩. বাটন কন্ট্রোল
        document.getElementById('micBtn').onclick = () => {
            const active = localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
            document.getElementById('micBtn').classList.toggle('active', active);
            document.getElementById('micIcon').className = active ? 'fas fa-microphone' : 'fas fa-microphone-slash';
            document.getElementById('micText').innerText = active ? 'Mute' : 'Unmute';
            db.ref('users/' + myId).update({ isMuted: !active });
        };

        db.ref('users').on('value', snap => {
            const users = snap.val();
            const list = document.getElementById('userList');
            list.innerHTML = '';
            for(let id in users) {
                const u = users[id];
                list.innerHTML += `<div class="user-card"><div class="avatar ${!u.isMuted ? 'voice-active' : ''}"><i class="fas fa-user"></i></div><div class="user-name">${u.id==myId?'You':u.id}<br><small>${u.isMuted?'Muted':'Speaking'}</small></div></div>`;
            }
        });

        document.getElementById('leaveBtn').onclick = () => { location.reload(); };

        startApp();
    </script>
</body>
</html>
